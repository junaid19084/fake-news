# Build stage
FROM node:20-alpine AS builder
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm install
COPY . .
# Pass environment variables to the build
ARG REACT_APP_API_URL
ENV REACT_APP_API_URL=${REACT_APP_API_URL:-http://detector-ml:8000}
RUN npm run build

# Serve stage
FROM nginx:alpine
COPY --from=builder /app/build /usr/share/nginx/html

# Add custom nginx config for SPA routing
RUN echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Nginx Config</title></head><body><h1>Config generated by Docker</h1></body></html>' > /usr/share/nginx/html/config.html

# Copy a custom nginx config to enable SPA routing
COPY --from=builder /app/build /usr/share/nginx/html
RUN rm /etc/nginx/conf.d/default.conf
COPY nginx.conf /etc/nginx/conf.d

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
